<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—ã–ª–æ –¥–µ–ª–æ - –ú–æ—è –∫–∞—Ä—Ç–∞</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=–≤–∞—à_–∫–ª—é—á&lang=ru_RU" type="text/javascript"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 100vh; }
        .controls { position: absolute; top: 10px; right: 10px; z-index: 1000; }
        button { padding: 10px; margin: 5px; background: #fff; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <button onclick="addPlaceMode()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</button>
        <button onclick="shareMap()">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>

    <script>
        let map, addPlaceListener;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        ymaps.ready(init);
        
        function init() {
            map = new ymaps.Map("map", {
                center: [55.76, 37.64],  // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                zoom: 10
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–∫–∏
            loadPlaces();
        }
        
        function loadPlaces() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–æ–∫ —á–µ—Ä–µ–∑ API
            fetch('/api/places?user_id={{ user_id }}')
                .then(response => response.json())
                .then(places => {
                    places.forEach(place => {
                        addPlaceToMap(place);
                    });
                });
        }
        
        function addPlaceToMap(place) {
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
            const placemark = new ymaps.Placemark([place.lat, place.lon], {
                balloonContent: `<h3>${place.title}</h3><p>${place.description}</p>`
            });
            map.geoObjects.add(placemark);
        }
        
        function addPlaceMode() {
            // –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏
            alert('–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –≥–¥–µ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É');
            
            if (addPlaceListener) {
                addPlaceListener.events.remove('click');
            }
            
            addPlaceListener = map.events.add('click', function (e) {
                const coords = e.get('coords');
                addNewPlace(coords);
            });
        }
        
        function addNewPlace(coords) {
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏
            const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞:');
            if (title) {
                const description = prompt('–û–ø–∏—Å–∞–Ω–∏–µ:');
                const date = new Date().toISOString().split('T')[0];
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                fetch('/api/places', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: '{{ user_id }}',
                        title: title,
                        description: description,
                        address: '',
                        lat: coords[0],
                        lon: coords[1],
                        date_visited: date,
                        main_photo: '',
                        photos: '[]'
                    })
                }).then(() => {
                    location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏
                });
            }
        }
        
        function shareMap() {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ–±—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
            const shareUrl = `${window.location.origin}/guest/{{ user_id }}`;
            prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –¥–ª—è –æ–±—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞:', shareUrl);
        }
    </script>
</body>
</html>
