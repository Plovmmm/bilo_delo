<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è –ë—ã–ª–æ –¥–µ–ª–æ - –ú–æ—è –∫–∞—Ä—Ç–∞</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_key }}&lang=ru_RU" type="text/javascript"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div id="map"></div>
    
    {% if is_admin %}
    <div class="controls">
        <button class="btn btn-primary" onclick="toggleAddMode()">
            <span class="btn-icon">‚ûï</span>
            <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</span>
        </button>
        <button class="btn btn-secondary" onclick="shareMap()">
            <span class="btn-icon">üîó</span>
            <span class="btn-text">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
        </button>
    </div>
    
    <!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π -->
    <div id="tempMarker" class="temp-marker hidden">
        <div class="marker-point"></div>
        <button class="marker-btn" onclick="openAddPanel()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</button>
    </div>

    <div id="addPlacePanel" class="panel hidden">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ</h3>
        <div class="form-group">
            <input type="text" id="placeTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ *" required>
        </div>
        <div class="form-group">
            <textarea id="placeDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
        </div>
        <div class="form-group">
            <input type="date" id="placeDate" value="{{ today }}">
        </div>
        <div class="form-actions">
            <button class="btn btn-cancel" onclick="cancelAddPlace()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-success" onclick="savePlace()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    {% endif %}

    <script>
        const USER_ID = "{{ user_id }}";
        const IS_ADMIN = {{ is_admin|tojson }};
        let map, addPlaceListener, selectedCoords, tempMarker;
        
        ymaps.ready(initMap);

        function initMap() {
            map = new ymaps.Map("map", {
                center: [55.76, 37.64],
                zoom: 10,
                controls: ['zoomControl', 'typeSelector', 'fullscreenControl']
            });
            
            loadPlaces();
            
            {% if is_admin %}
            setupAdminFeatures();
            {% endif %}
        }
        
        function loadPlaces() {
            fetch(`/api/places?user_id=${USER_ID}`)
                .then(response => response.json())
                .then(places => {
                    places.forEach(place => createPlacemark(place));
                });
        }
        
        function createPlacemark(place) {
            const placemark = new ymaps.Placemark([place.lat, place.lon], {
                balloonContentHeader: place.title,
                balloonContentBody: `
                    <div class="balloon-content">
                        <p><strong>–î–∞—Ç–∞:</strong> ${place.date_visited}</p>
                        ${place.description ? `<p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${place.description}</p>` : ''}
                        ${place.address ? `<p><strong>–ê–¥—Ä–µ—Å:</strong> ${place.address}</p>` : ''}
                        ${place.photos && place.photos.length > 0 ? 
                            `<div class="place-photos">
                                ${place.photos.map(photo => 
                                    `<img src="${photo.url}" alt="${place.title}" style="max-width: 100px; margin: 5px;">`
                                ).join('')}
                            </div>` : ''}
                        ${IS_ADMIN ? `<button onclick="editPlace(${place.id})" class="balloon-btn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>` : ''}
                    </div>
                `
            }, {
                preset: 'islands#blueIcon'
            });
            
            map.geoObjects.add(placemark);
        }
        
        {% if is_admin %}
        function setupAdminFeatures() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∞
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
            map.events.add('click', function(e) {
                if (addPlaceListener) {
                    showTempMarker(e.get('coords'));
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç–µ
        function showTempMarker(coords) {
            selectedCoords = coords;  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
            if (tempMarker) {
                map.geoObjects.remove(tempMarker);
            }
        
            // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–Ω—É—é –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ
            tempMarker = new ymaps.Placemark(coords, {}, {
                preset: 'islands#redIcon',
                draggable: true  // –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –º–µ—Ç–∫—É
            });
        
            map.geoObjects.add(tempMarker);
        
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            getAddress(coords);
        
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏
            tempMarker.events.add('dragend', function() {
                const newCoords = tempMarker.geometry.getCoordinates();
                selectedCoords = newCoords;
                getAddress(newCoords);
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞
            document.getElementById('addPlacePanel').classList.remove('hidden');
        }
        
        function toggleAddMode() {
            if (addPlaceListener) {
                disableAddMode();
            } else {
                enableAddMode();
            }
        }
        
        function enableAddMode() {
            document.querySelector('.controls .btn-primary').classList.add('active');
            addPlaceListener = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω
        }
        
        function disableAddMode() {
            document.querySelector('.controls .btn-primary').classList.remove('active');
            document.getElementById('addPlacePanel').classList.add('hidden');
            
            // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
            if (tempMarker) {
                map.geoObjects.remove(tempMarker);
                tempMarker = null;
            }
            
            addPlaceListener = null;
        }
        
        function getAddress(coords) {
            // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            ymaps.geocode(coords).then(function (res) {
                const firstGeoObject = res.geoObjects.get(0);
                const address = firstGeoObject ? firstGeoObject.getAddressLine() : '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–¥—Ä–µ—Å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                selectedAddress = address;
            });
        }
        
        function savePlace() {
            const title = document.getElementById('placeTitle').value;
            if (!title || !selectedCoords) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ');
                return;
            }
            
            const placeData = {
                user_id: USER_ID,
                title: title,
                description: document.getElementById('placeDescription').value,
                date_visited: document.getElementById('placeDate').value,
                lat: selectedCoords[0],
                lon: selectedCoords[1],
                address: selectedAddress || ''
            };
            
            fetch('/api/places', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(placeData)
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      location.reload();
                  } else {
                      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
                  }
              });
        }
        
        function cancelAddPlace() {
            disableAddMode();
            document.getElementById('placeTitle').value = '';
            document.getElementById('placeDescription').value = '';
        }
        
        function shareMap() {
            const shareUrl = `${window.location.origin}/guest/${USER_ID}`;
            if (navigator.share) {
                navigator.share({
                    title: '–ú–æ—è –∫–∞—Ä—Ç–∞ "–ë—ã–ª–æ –¥–µ–ª–æ"',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!\n\n' + shareUrl);
                });
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞
        let selectedAddress = '';
        {% endif %}
    </script>
</body>
</html>
