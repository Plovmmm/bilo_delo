<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è –ë—ã–ª–æ –¥–µ–ª–æ - –ú–æ—è –∫–∞—Ä—Ç–∞</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_key }}&lang=ru_RU" type="text/javascript"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
</head>
<body>
    <div id="map"></div>
    
    <!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π -->
    <div id="tempMarker" class="temp-marker hidden">
        <div class="marker-point"></div>
        <button class="marker-btn" onclick="openAddPanel()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</button>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞ -->
    <div id="addPlacePanel" class="panel hidden">
        <div class="panel-header">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ</h3>
            <button class="btn-close" onclick="closeAddPanel()">√ó</button>
        </div>
        
        <form id="placeForm" class="form">
            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ -->
            <div class="form-section">
                <label class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –º–µ—Å—Ç–∞</label>
                <div class="photo-upload">
                    <div class="photo-main">
                        <label for="mainPhoto" class="photo-upload-area">
                            <input type="file" id="mainPhoto" accept="image/*" class="hidden">
                            <span class="photo-icon">üì∑</span>
                            <span class="photo-text">–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ *</span>
                            <img id="mainPhotoPreview" class="hidden">
                        </label>
                    </div>
                    <div class="photo-additional">
                        <label for="photo1" class="photo-upload-area small">
                            <input type="file" id="photo1" accept="image/*" class="hidden">
                            <span class="photo-icon">‚ûï</span>
                            <span>–§–æ—Ç–æ 2</span>
                            <img id="photo1Preview" class="hidden">
                        </label>
                        <label for="photo2" class="photo-upload-area small">
                            <input type="file" id="photo2" accept="image/*" class="hidden">
                            <span class="photo-icon">‚ûï</span>
                            <span>–§–æ—Ç–æ 3</span>
                            <img id="photo2Preview" class="hidden">
                        </label>
                        <label for="photo3" class="photo-upload-area small">
                            <input type="file" id="photo3" accept="image/*" class="hidden">
                            <span class="photo-icon">‚ûï</span>
                            <span>–§–æ—Ç–æ 4</span>
                            <img id="photo3Preview" class="hidden">
                        </label>
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="form-group">
                <label for="placeTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ *</label>
                <input type="text" id="placeTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–µ—Å—Ç–æ—Ä–∞–Ω '–£ –æ–∑–µ—Ä–∞'" required>
            </div>

            <div class="form-group">
                <label for="placeDate" class="form-label">–î–∞—Ç–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è *</label>
                <input type="date" id="placeDate" value="{{ today }}" required>
            </div>

            <div class="form-group">
                <label for="placeAddress" class="form-label">–ê–¥—Ä–µ—Å</label>
                <input type="text" id="placeAddress" placeholder="–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" readonly>
                <small>–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–µ –Ω–∞ –∫–∞—Ä—Ç–µ</small>
            </div>

            <div class="form-group">
                <label for="placeDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="placeDescription" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–∏—Ö –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è—Ö..." rows="4"></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-cancel" onclick="closeAddPanel()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Å—Ç–æ</button>
            </div>
        </form>
    </div>

    <script>
        const USER_ID = "{{ user_id }}";
        const IS_ADMIN = {{ is_admin|tojson }};
        const TODAY = "{{ today }}";
        let map, tempMarker, selectedCoords;
        
        ymaps.ready(initMap);
        
        function initMap() {
            map = new ymaps.Map("map", {
                center: [55.76, 37.64],
                zoom: 10,
                controls: ['zoomControl', 'typeSelector', 'fullscreenControl']
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.events.add('click', function(e) {
                showTempMarker(e.get('coords'));
            });
            
            loadPlaces();
        }
        
        function showTempMarker(coords) {
            selectedCoords = coords;
            
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
            if (tempMarker) {
                map.geoObjects.remove(tempMarker);
            }
            
            // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–Ω—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
            tempMarker = new ymaps.Placemark(coords, {}, {
                preset: 'islands#redIcon',
                draggable: true
            });
            
            map.geoObjects.add(tempMarker);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ"
            showAddButton(coords);
            
            // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            getAddress(coords);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏
            tempMarker.events.add('dragend', function() {
                const newCoords = tempMarker.geometry.getCoordinates();
                selectedCoords = newCoords;
                showAddButton(newCoords);
                getAddress(newCoords);
            });
        }
        
        function showAddButton(coords) {
            const tempMarkerElement = document.getElementById('tempMarker');
            const pixelCoords = map.convertToPagePixels(coords);
            
            tempMarkerElement.style.left = (pixelCoords[0] + 20) + 'px';
            tempMarkerElement.style.top = (pixelCoords[1] - 40) + 'px';
            tempMarkerElement.classList.remove('hidden');
        }
        
        function hideAddButton() {
            document.getElementById('tempMarker').classList.add('hidden');
        }
        
        function openAddPanel() {
            document.getElementById('addPlacePanel').classList.remove('hidden');
            hideAddButton();
            initPhotoUpload();
        }
        
        function closeAddPanel() {
            document.getElementById('addPlacePanel').classList.add('hidden');
            
            // –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
            if (tempMarker) {
                map.geoObjects.remove(tempMarker);
                tempMarker = null;
            }
            
            clearForm();
        }
        
        function getAddress(coords) {
            ymaps.geocode(coords).then(function(res) {
                const firstGeoObject = res.geoObjects.get(0);
                const address = firstGeoObject ? firstGeoObject.getAddressLine() : '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                document.getElementById('placeAddress').value = address;
            });
        }
        
        function loadPlaces() {
            fetch(`/api/places?user_id=${USER_ID}`)
                .then(response => response.json())
                .then(places => {
                    places.forEach(place => createPlacemark(place));
                });
        }
        
        function createPlacemark(place) {
            const placemark = new ymaps.Placemark([place.lat, place.lon], {
                balloonContentHeader: place.title,
                balloonContentBody: `
                    <div class="balloon-content">
                        <p><strong>–î–∞—Ç–∞:</strong> ${place.date_visited}</p>
                        ${place.description ? `<p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${place.description}</p>` : ''}
                        ${place.address ? `<p><strong>–ê–¥—Ä–µ—Å:</strong> ${place.address}</p>` : ''}
                        ${place.photos && place.photos.length > 0 ? 
                            `<div class="place-photos">
                                ${place.photos.map(photo => 
                                    `<img src="${photo.url}" alt="${place.title}" style="max-width: 100px; margin: 5px;">`
                                ).join('')}
                            </div>` : ''}
                        ${IS_ADMIN ? `<button onclick="editPlace(${place.id})" class="balloon-btn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>` : ''}
                    </div>
                `
            }, {
                preset: 'islands#blueIcon'
            });
            
            map.geoObjects.add(placemark);
        }
        
        function initPhotoUpload() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
            const photoInputs = ['mainPhoto', 'photo1', 'photo2', 'photo3'];
            
            photoInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                const preview = document.getElementById(inputId + 'Preview');
                const uploadArea = input.parentElement;
                
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        previewFile(file, preview, uploadArea);
                    }
                });
                
                // Drag and drop
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', function() {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) {
                        input.files = e.dataTransfer.files;
                        previewFile(file, preview, uploadArea);
                    }
                });
                
                // –ö–ª–∏–∫ –ø–æ –ø—Ä–µ–≤—å—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                preview.addEventListener('click', function() {
                    removePhoto(input, preview, uploadArea);
                });
            });
        }
        
        function previewFile(file, preview, uploadArea) {
            if (!file.type.match('image.*')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                uploadArea.querySelector('.photo-icon').classList.add('hidden');
                uploadArea.querySelector('.photo-text').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        function removePhoto(input, preview, uploadArea) {
            input.value = '';
            preview.src = '';
            preview.classList.add('hidden');
            uploadArea.querySelector('.photo-icon').classList.remove('hidden');
            uploadArea.querySelector('.photo-text').classList.remove('hidden');
        }
        
        function clearForm() {
            document.getElementById('placeForm').reset();
            document.getElementById('placeDate').value = TODAY;
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ
            const previews = ['mainPhotoPreview', 'photo1Preview', 'photo2Preview', 'photo3Preview'];
            const inputs = ['mainPhoto', 'photo1', 'photo2', 'photo3'];
            
            previews.forEach(previewId => {
                const preview = document.getElementById(previewId);
                preview.src = '';
                preview.classList.add('hidden');
            });
            
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                const uploadArea = input.parentElement;
                uploadArea.querySelector('.photo-icon').classList.remove('hidden');
                uploadArea.querySelector('.photo-text').classList.remove('hidden');
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('placeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            savePlace();
        });
        
        function savePlace() {
            const title = document.getElementById('placeTitle').value.trim();
            const mainPhoto = document.getElementById('mainPhoto').files[0];
            
            if (!title) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞');
                return;
            }
            
            if (!selectedCoords) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ');
                return;
            }
            
            if (!mainPhoto) {
                alert('–î–æ–±–∞–≤—å—Ç–µ –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ');
                return;
            }
            
            const formData = new FormData();
            formData.append('user_id', USER_ID);
            formData.append('title', title);
            formData.append('date_visited', document.getElementById('placeDate').value);
            formData.append('address', document.getElementById('placeAddress').value);
            formData.append('description', document.getElementById('placeDescription').value);
            formData.append('lat', selectedCoords[0]);
            formData.append('lon', selectedCoords[1]);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ
            const photoInputs = ['mainPhoto', 'photo1', 'photo2', 'photo3'];
            photoInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input.files[0]) {
                    formData.append('photos', input.files[0]);
                }
            });
            
            fetch('/api/places', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–ú–µ—Å—Ç–æ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
                    closeAddPanel();
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            });
        }
        
        function shareMap() {
            const shareUrl = `${window.location.origin}/guest/${USER_ID}`;
            if (navigator.share) {
                navigator.share({
                    title: '–ú–æ—è –∫–∞—Ä—Ç–∞ "–ë—ã–ª–æ –¥–µ–ª–æ"',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!\n\n' + shareUrl);
                });
            }
        }
    </script>
</body>
</html>