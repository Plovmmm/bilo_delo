<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è –ë—ã–ª–æ –¥–µ–ª–æ - –ú–æ—è –∫–∞—Ä—Ç–∞</title>
    <!-- –ó–∞–º–µ–Ω–∏—Ç–µ YOUR_API_KEY –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –Ø–Ω–¥–µ–∫—Å -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=e3ae341e-a8e0-4284-8d2f-cc20984dc27e&lang=ru_RU" type="text/javascript"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div id="map"></div>
    
    {% if is_admin %}
    <div class="controls">
        <button class="btn btn-primary" onclick="toggleAddMode()">
            <span class="btn-icon">‚ûï</span>
            <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</span>
        </button>
        <button class="btn btn-secondary" onclick="shareMap()">
            <span class="btn-icon">üîó</span>
            <span class="btn-text">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
        </button>
    </div>

    <div id="addPlacePanel" class="panel hidden">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ</h3>
        <div class="form-group">
            <input type="text" id="placeTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ *" required>
        </div>
        <div class="form-group">
            <textarea id="placeDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
        </div>
        <div class="form-group">
            <input type="date" id="placeDate" value="{{ today }}">
        </div>
        <div class="form-group">
            <div class="address-input-container">
                <input type="text" id="placeAddress" placeholder="–ê–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞" 
                       onkeypress="handleAddressKeypress(event)"
                       oninput="showSuggestions(this.value)">
                <button type="button" class="btn-geocode" onclick="geocodeAddress()" title="–ù–∞–π—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–µ">
                    <span class="btn-icon">üìç</span>
                </button>
            </div>
            <div id="suggestions" class="suggestions-container"></div>
            <div id="addressStatus" class="address-status"></div>
        </div>
        <div class="form-actions">
            <button class="btn btn-cancel" onclick="cancelAddPlace()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-success" onclick="savePlace()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    {% endif %}

    <script>
        const USER_ID = "{{ user_id }}";
        const IS_ADMIN = {{ is_admin|tojson }};
        let map, addPlaceListener, selectedCoords, tempMarker, selectedAddress = '';
        let suggestTimeout;
        
        ymaps.ready(initMap);

        function initMap() {
            map = new ymaps.Map("map", {
                center: [55.76, 37.64],
                zoom: 10,
                controls: ['zoomControl', 'typeSelector', 'fullscreenControl']
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Å—Ç–∞, –µ—Å–ª–∏ API –¥–æ—Å—Ç—É–ø–Ω–æ
            try {
                loadPlaces();
            } catch (e) {
                console.log('API –º–µ—Å—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
            }
            
            {% if is_admin %}
            setupAdminFeatures();
            {% endif %}
        }
        
        function loadPlaces() {
            fetch(`/api/places?user_id=${USER_ID}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
                    }
                    return response.json();
                })
                .then(places => {
                    places.forEach(place => createPlacemark(place));
                })
                .catch(error => {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Å—Ç:', error);
                });
        }
        
        function createPlacemark(place) {
            const placemark = new ymaps.Placemark([place.lat, place.lon], {
                balloonContentHeader: place.title,
                balloonContentBody: `
                    <div class="balloon-content">
                        <p><strong>–î–∞—Ç–∞:</strong> ${place.date_visited}</p>
                        ${place.description ? `<p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${place.description}</p>` : ''}
                        ${place.address ? `<p><strong>–ê–¥—Ä–µ—Å:</strong> ${place.address}</p>` : ''}
                        ${IS_ADMIN ? `<button onclick="editPlace(${place.id})" class="balloon-btn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>` : ''}
                    </div>
                `
            }, {
                preset: 'islands#blueIcon'
            });
            
            map.geoObjects.add(placemark);
        }
        
        {% if is_admin %}
        function setupAdminFeatures() {
            map.events.add('click', function(e) {
                if (addPlaceListener) {
                    showTempMarker(e.get('coords'));
                }
            });
        }

        function showTempMarker(coords) {
            selectedCoords = coords;
        
            if (tempMarker) {
                map.geoObjects.remove(tempMarker);
            }
        
            tempMarker = new ymaps.Placemark(coords, {}, {
                preset: 'islands#redIcon',
                draggable: true,
                balloonContent: '–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ'
            });
        
            map.geoObjects.add(tempMarker);
        
            getAddressFromCoords(coords);
        
            tempMarker.events.add('dragend', function() {
                const newCoords = tempMarker.geometry.getCoordinates();
                selectedCoords = newCoords;
                getAddressFromCoords(newCoords);
            });
            
            document.getElementById('addPlacePanel').classList.remove('hidden');
        }
        
        // –£–º–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∞–¥—Ä–µ—Å–∞–º–∏ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
        function geocodeAddress() {
            const query = document.getElementById('placeAddress').value.trim();
            
            if (!query) {
                updateAddressStatus('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞', 'warning');
                return;
            }
            
            updateAddressStatus('–ò—â–µ–º...', 'loading');
            hideSuggestions();
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º suggest –¥–ª—è –±–æ–ª–µ–µ —É–º–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
            ymaps.suggest(query).then(function(items) {
                if (items.length > 0) {
                    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∏ —Å–∞–º—ã–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
                    const bestMatch = items[0];
                    return ymaps.geocode(bestMatch.value);
                } else {
                    // –ï—Å–ª–∏ suggest –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
                    return ymaps.geocode(query);
                }
            }).then(function(res) {
                const foundObjects = res.geoObjects;
                
                if (foundObjects.getLength() === 0) {
                    updateAddressStatus('–ú–µ—Å—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å', 'error');
                    return;
                }
                
                // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const firstFoundObject = foundObjects.get(0);
                const foundCoords = firstFoundObject.geometry.getCoordinates();
                const foundAddress = firstFoundObject.getAddressLine();
                const foundName = firstFoundObject.properties.get('name') || foundAddress;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                selectedCoords = foundCoords;
                selectedAddress = foundAddress;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–æ –ø—É—Å—Ç–æ–µ
                if (!document.getElementById('placeTitle').value) {
                    document.getElementById('placeTitle').value = foundName;
                }
                
                document.getElementById('placeAddress').value = foundAddress;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É
                if (tempMarker) {
                    tempMarker.geometry.setCoordinates(foundCoords);
                } else {
                    showTempMarker(foundCoords);
                }
                
                // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
                map.setCenter(foundCoords, 15, {duration: 500});
                
                updateAddressStatus('–ú–µ—Å—Ç–æ –Ω–∞–π–¥–µ–Ω–æ!', 'success');
                
            }).catch(function(err) {
                console.log('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', err);
                updateAddressStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—Ä–æ—Å', 'error');
            });
        }
        
        // –ü–æ–∫–∞–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
        function showSuggestions(query) {
            if (!query || query.length < 2) {
                hideSuggestions();
                return;
            }
            
            clearTimeout(suggestTimeout);
            suggestTimeout = setTimeout(() => {
                ymaps.suggest(query).then(function(items) {
                    const container = document.getElementById('suggestions');
                    container.innerHTML = '';
                    
                    if (items.length === 0) {
                        hideSuggestions();
                        return;
                    }
                    
                    items.slice(0, 5).forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = item.value;
                        div.onclick = function() {
                            document.getElementById('placeAddress').value = item.value;
                            hideSuggestions();
                            geocodeAddress();
                        };
                        container.appendChild(div);
                    });
                    
                    container.classList.remove('hidden');
                });
            }, 300);
        }
        
        function hideSuggestions() {
            document.getElementById('suggestions').classList.add('hidden');
        }
        
        function getAddressFromCoords(coords) {
            updateAddressStatus('–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å...', 'loading');
            
            ymaps.geocode(coords).then(function(res) {
                const firstGeoObject = res.geoObjects.get(0);
                
                if (firstGeoObject) {
                    const address = firstGeoObject.getAddressLine();
                    selectedAddress = address;
                    document.getElementById('placeAddress').value = address;
                    updateAddressStatus('–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω', 'success');
                } else {
                    selectedAddress = '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                    document.getElementById('placeAddress').value = '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                    updateAddressStatus('–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω', 'warning');
                }
            }).catch(function(err) {
                console.log('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                selectedAddress = '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                document.getElementById('placeAddress').value = '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                updateAddressStatus('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞', 'error');
            });
        }
        
        function handleAddressKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                geocodeAddress();
            }
        }
        
        function updateAddressStatus(message, type) {
            const statusElement = document.getElementById('addressStatus');
            statusElement.textContent = message;
            statusElement.className = 'address-status ' + type;
        }
        
        function toggleAddMode() {
            if (addPlaceListener) {
                disableAddMode();
            } else {
                enableAddMode();
            }
        }
        
        function enableAddMode() {
            document.querySelector('.controls .btn-primary').classList.add('active');
            addPlaceListener = true;
            updateAddressStatus('–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å/–Ω–∞–∑–≤–∞–Ω–∏–µ', 'info');
        }
        
        function disableAddMode() {
            document.querySelector('.controls .btn-primary').classList.remove('active');
            document.getElementById('addPlacePanel').classList.add('hidden');
            hideSuggestions();
            
            if (tempMarker) {
                map.geoObjects.remove(tempMarker);
                tempMarker = null;
            }
            
            document.getElementById('placeTitle').value = '';
            document.getElementById('placeDescription').value = '';
            document.getElementById('placeAddress').value = '';
            updateAddressStatus('', '');
            
            addPlaceListener = null;
            selectedCoords = null;
            selectedAddress = '';
        }
        
        function savePlace() {
            const title = document.getElementById('placeTitle').value;
            if (!title || !selectedCoords) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ');
                return;
            }
            
            const address = document.getElementById('placeAddress').value.trim() || selectedAddress;
            
            const placeData = {
                user_id: USER_ID,
                title: title,
                description: document.getElementById('placeDescription').value,
                date_visited: document.getElementById('placeDate').value,
                lat: selectedCoords[0],
                lon: selectedCoords[1],
                address: address
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Å—Ç–æ (–∑–∞–≥–ª—É—à–∫–∞ - –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±—ç–∫–µ–Ω–¥)
            console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Å—Ç–∞:', placeData);
            alert('–§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—ç–∫–µ–Ω–¥ API');
            
            // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
            // createPlacemark({
            //     lat: selectedCoords[0],
            //     lon: selectedCoords[1],
            //     title: title,
            //     date_visited: document.getElementById('placeDate').value,
            //     description: document.getElementById('placeDescription').value,
            //     address: address
            // });
            // disableAddMode();
        }
        
        function cancelAddPlace() {
            disableAddMode();
        }
        
        function shareMap() {
            const shareUrl = `${window.location.origin}/guest/${USER_ID}`;
            if (navigator.share) {
                navigator.share({
                    title: '–ú–æ—è –∫–∞—Ä—Ç–∞ "–ë—ã–ª–æ –¥–µ–ª–æ"',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!\n\n' + shareUrl);
                });
            }
        }
        {% endif %}
    </script>

    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
        .suggestions-container {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1002;
            width: calc(100% - 40px);
        }
        
        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .hidden {
            display: none;
        }
        
        .address-input-container {
            position: relative;
        }
    </style>
</body>
</html>
