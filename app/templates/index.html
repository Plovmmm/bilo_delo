<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è –ë—ã–ª–æ –¥–µ–ª–æ - –ú–æ—è –∫–∞—Ä—Ç–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_key }}&lang=ru_RU" type="text/javascript"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div id="map"></div>
    
    {% if is_admin %}
    <div class="controls">
        <button class="btn btn-primary" onclick="toggleAddMode()">
            <span class="btn-icon">‚ûï</span>
            <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</span>
        </button>
        <button class="btn btn-secondary" onclick="shareMap()">
            <span class="btn-icon">üîó</span>
            <span class="btn-text">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
        </button>
    </div>

    <div id="addPlacePanel" class="panel hidden">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ</h3>
        
        <div class="photo-upload-section">
            <div class="photo-column">
                <div class="photo-upload-main">
                    <div class="photo-preview" id="mainPhotoPreview">
                        <span class="photo-placeholder">üì∑</span>
                        <div class="photo-label">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ</div>
                    </div>
                    <input type="file" id="mainPhotoInput" accept="image/*" class="photo-input" 
                           onchange="handleMainPhotoUpload(event)">
                    <button type="button" class="btn-remove-photo" onclick="removeMainPhoto()">√ó</button>
                </div>
                
                <div class="photo-upload-main">
                    <div class="photo-preview secondary" id="secondaryPhotoPreview">
                        <span class="photo-placeholder">‚ûï</span>
                        <div class="photo-label secondary">–î–æ–±–∞–≤—å—Ç–µ –¥–æ 3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ</div>
                    </div>
                    <input type="file" id="secondaryPhotoInput" accept="image/*" class="photo-input" 
                           multiple onchange="handleSecondaryPhotoUpload(event)">
                    <button type="button" class="btn-remove-photo" onclick="removeAllSecondaryPhotos()">√ó</button>
                </div>
            </div>
            
            <div class="form-column">
                <div class="form-group">
                    <input type="text" id="placeTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ *" required>
                </div>
                <div class="form-group">
                    <textarea id="placeDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                </div>
                <div class="form-group">
                    <input type="date" id="placeDate" value="{{ today }}">
                </div>
                <div class="form-group">
                    <div class="address-input-container">
                        <input type="text" id="placeAddress" placeholder="–ê–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞" 
                               onkeypress="handleAddressKeypress(event)"
                               oninput="showSuggestions(this.value)">
                        <button type="button" class="btn-geocode" onclick="geocodeAddress()" title="–ù–∞–π—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–µ">
                            <span class="btn-icon">üìç</span>
                        </button>
                    </div>
                    <div id="suggestions" class="suggestions-container hidden"></div>
                    <div id="addressStatus" class="address-status"></div>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button class="btn btn-cancel" onclick="cancelAddPlace()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-success" onclick="savePlace()" id="saveButton">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    {% endif %}

    <!-- –ü–∞–Ω–µ–ª—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ—Ç–∫–∏ -->
    <div id="viewMarkPanel" class="panel hidden">
        <div class="panel-header">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–µ</h3>
            <button class="btn-close" onclick="closeViewMarkPanel()">√ó</button>
        </div>
        
        <div class="mark-details">
            <!-- –ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ -->
            <div class="main-photo-section" id="mainPhotoSection">
                <img id="viewMainPhoto" src="" alt="–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ" class="main-photo">
            </div>
            
            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ -->
            <div class="secondary-photos-section" id="secondaryPhotosSection">
                <h4>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ</h4>
                <div class="photos-grid" id="secondaryPhotosGrid">
                    <!-- –§–æ—Ç–æ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                </div>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–µ -->
            <div class="mark-info">
                <div class="info-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                    <div id="viewMarkTitle" class="info-value"></div>
                </div>
                
                <div class="info-group">
                    <label>–î–∞—Ç–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è:</label>
                    <div id="viewMarkDate" class="info-value"></div>
                </div>
                
                <div class="info-group">
                    <label>–ê–¥—Ä–µ—Å:</label>
                    <div id="viewMarkAddress" class="info-value"></div>
                </div>
                
                <div class="info-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <div id="viewMarkDescription" class="info-value"></div>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button class="btn btn-secondary" onclick="closeViewMarkPanel()">–ó–∞–∫—Ä—ã—Ç—å</button>
            {% if is_admin %}
            <button class="btn btn-danger" onclick="deleteMark()">
                <span class="btn-icon">üóëÔ∏è</span>
                <span class="btn-text">–£–¥–∞–ª–∏—Ç—å</span>
            </button>
            <button class="btn btn-warning" onclick="editMark()">
                <span class="btn-icon">‚úèÔ∏è</span>
                <span class="btn-text">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
            </button>
            {% endif %}
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–∫–∏ -->
    <div id="editMarkPanel" class="panel hidden">
        <div class="panel-header">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ</h3>
            <button class="btn-close" onclick="cancelEdit()">√ó</button>
        </div>
        
        <div class="photo-upload-section">
            <div class="photo-column">
                <div class="photo-upload-main">
                    <div class="photo-preview" id="editMainPhotoPreview">
                        <span class="photo-placeholder">üì∑</span>
                        <div class="photo-label">–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ</div>
                    </div>
                    <input type="file" id="editMainPhotoInput" accept="image/*" class="photo-input" 
                           onchange="handleEditMainPhotoUpload(event)">
                    <button type="button" class="btn-remove-photo" onclick="removeEditMainPhoto()">√ó</button>
                </div>
                
                <div class="photo-upload-main">
                    <div class="photo-preview secondary" id="editSecondaryPhotoPreview">
                        <span class="photo-placeholder">‚ûï</span>
                        <div class="photo-label secondary">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ</div>
                    </div>
                    <input type="file" id="editSecondaryPhotoInput" accept="image/*" class="photo-input" 
                           multiple onchange="handleEditSecondaryPhotoUpload(event)">
                    <button type="button" class="btn-remove-photo" onclick="removeAllEditSecondaryPhotos()">√ó</button>
                </div>
            </div>
            
            <div class="form-column">
                <div class="form-group">
                    <input type="text" id="editPlaceTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ *" required>
                </div>
                <div class="form-group">
                    <textarea id="editPlaceDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                </div>
                <div class="form-group">
                    <input type="date" id="editPlaceDate">
                </div>
                <div class="form-group">
                    <div class="address-input-container">
                        <input type="text" id="editPlaceAddress" placeholder="–ê–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞"
                               onkeypress="handleEditAddressKeypress(event)"
                               oninput="showEditSuggestions(this.value)">
                        <button type="button" class="btn-geocode" onclick="geocodeEditAddress()" title="–ù–∞–π—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–µ">
                            <span class="btn-icon">üìç</span>
                        </button>
                    </div>
                    <div id="editSuggestions" class="suggestions-container hidden"></div>
                    <div id="editAddressStatus" class="address-status"></div>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button class="btn btn-cancel" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-success" onclick="saveEditedMark()" id="saveEditButton">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        const TELEGRAM_USER_ID = tg.initDataUnsafe?.user?.id;
        const IS_REGISTER = {{ is_register|tojson }};
        
        // –ï—Å–ª–∏ ID –Ω–µ –ø–æ–ª—É—á–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        if (!TELEGRAM_USER_ID) {
            document.body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; padding: 20px; text-align: center;">
                    <h2 style="color: #ff3b30; margin-bottom: 20px;">–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h2>
                    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.</p>
                </div>
            `;
        } else {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ID –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            if (!IS_REGISTER) {
                initApp(TELEGRAM_USER_ID);
            }
        }
        
        function initApp(userId) {
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∏ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
            // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å user_id
            window.location.href = `?user_id=${userId}`;
        }

        // const TELEGRAM_USER_ID = 855159736;
        const IS_ADMIN = {{ is_admin|tojson }};
        
        let map, addPlaceListener, selectedCoords, tempMarker, selectedAddress = '';
        let suggestTimeout;
        let uploadedPhotos = {
            main: null,
            secondary: []
        };
        let editUploadedPhotos = {
            main: null,
            secondary: []
        };
        const MAX_SECONDARY_PHOTOS = 3;
        let currentMarkId = null;
        let currentEditingMark = null;
        
        ymaps.ready(initMap);

        function initMap() {
            map = new ymaps.Map("map", {
                center: [59.93, 30.30],
                zoom: 12,
                controls: ['zoomControl', 'typeSelector', 'fullscreenControl']
            });
            
            try {
                loadPlaces();
            } catch (e) {
                console.log('API –º–µ—Å—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
            }
            
            {% if is_admin %}
            setupAdminFeatures();
            setupPhotoUploads();
            {% endif %}
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.address-input-container') && 
                    !e.target.closest('.suggestions-container')) {
                    hideSuggestions();
                    hideEditSuggestions();
                }
            });
        }
        
        function setupPhotoUploads() {
            document.getElementById('mainPhotoPreview').addEventListener('click', function() {
                document.getElementById('mainPhotoInput').click();
            });
            
            document.getElementById('secondaryPhotoPreview').addEventListener('click', function() {
                document.getElementById('secondaryPhotoInput').click();
            });

            document.getElementById('editMainPhotoPreview').addEventListener('click', function() {
                document.getElementById('editMainPhotoInput').click();
            });
            
            document.getElementById('editSecondaryPhotoPreview').addEventListener('click', function() {
                document.getElementById('editSecondaryPhotoInput').click();
            });
        }
        
        function handleMainPhotoUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('mainPhotoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ">`;
                    preview.classList.add('has-photo');
                    uploadedPhotos.main = file;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function handleSecondaryPhotoUpload(event) {
            const files = Array.from(event.target.files);
            const availableSlots = MAX_SECONDARY_PHOTOS - uploadedPhotos.secondary.length;
            
            if (availableSlots <= 0) {
                showNotification(`–ú–∞–∫—Å–∏–º—É–º –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å ${MAX_SECONDARY_PHOTOS} –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ`, 'warning');
                return;
            }
            
            const filesToUpload = files.slice(0, availableSlots);
            
            if (files.length > availableSlots) {
                showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${filesToUpload.length} –∏–∑ ${files.length} —Ñ–æ—Ç–æ. –ú–∞–∫—Å–∏–º—É–º: ${MAX_SECONDARY_PHOTOS}`, 'info');
            }
            
            filesToUpload.forEach((file) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedPhotos.secondary.push({
                            file: file,
                            url: e.target.result
                        });
                        updateSecondaryPhotoPreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function updateSecondaryPhotoPreview() {
            const preview = document.getElementById('secondaryPhotoPreview');
            const photoCount = uploadedPhotos.secondary.length;
            
            if (photoCount === 0) {
                preview.innerHTML = '<span class="photo-placeholder">‚ûï</span><div class="photo-label secondary">–î–æ–±–∞–≤—å—Ç–µ –¥–æ 3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ</div>';
                preview.classList.remove('has-photos');
                return;
            }
            
            let previewHTML = '';
            
            if (photoCount === 1) {
                previewHTML = `<img src="${uploadedPhotos.secondary[0].url}" alt="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ 1">`;
            } else {
                previewHTML = '<div class="photo-preview-grid">';
                uploadedPhotos.secondary.slice(0, 4).forEach((photo, index) => {
                    previewHTML += `<img src="${photo.url}" alt="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ ${index + 1}">`;
                });
                previewHTML += '</div>';
            }
            
            previewHTML += `<div class="photo-counter">${photoCount}/${MAX_SECONDARY_PHOTOS}</div>`;
            preview.innerHTML = previewHTML;
            preview.classList.add('has-photos');
        }
        
        function removeMainPhoto() {
            const preview = document.getElementById('mainPhotoPreview');
            preview.innerHTML = '<span class="photo-placeholder">üì∑</span><div class="photo-label">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ</div>';
            preview.classList.remove('has-photo');
            uploadedPhotos.main = null;
            document.getElementById('mainPhotoInput').value = '';
        }
        
        function removeAllSecondaryPhotos() {
            const preview = document.getElementById('secondaryPhotoPreview');
            preview.innerHTML = '<span class="photo-placeholder">‚ûï</span><div class="photo-label secondary">–î–æ–±–∞–≤—å—Ç–µ –¥–æ 3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ</div>';
            preview.classList.remove('has-photos');
            uploadedPhotos.secondary = [];
            document.getElementById('secondaryPhotoInput').value = '';
        }
        
        function loadPlaces() {
            fetch(`api/get_marks/${TELEGRAM_USER_ID}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
                    }
                    return response.json();
                })
                .then(response => {
                    if (response.success && response.marks) {
                        response.marks.forEach(place => createPlacemark(place));
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Å—Ç:', error);
                });
        }
        
        function createPlacemark(place) {
            const coords = [parseFloat(place.lat), parseFloat(place.lon)]
            
            const placemark = new ymaps.Placemark(coords, {
                balloonContentHeader: place.title,
                balloonContentBody: `
                    <div class="balloon-content">
                        <p><strong>–î–∞—Ç–∞:</strong> ${place.visit_date}</p>
                        ${place.address ? `<p><strong>–ê–¥—Ä–µ—Å:</strong> ${place.address}</p>` : ''}
                        <button onclick="viewMarkDetails(${place.id})" class="balloon-btn">
                            üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                    </div>
                `
            }, {
                preset: 'islands#blueIcon',
                balloonCloseButton: true
            });

            placemark.events.add('click', function(e) {
                e.preventDefault();
                viewMarkDetails(place.id);
            });

            map.geoObjects.add(placemark);
            return placemark;
        }
        
        async function viewMarkDetails(markId) {
            try {
                const response = await fetch(`/api/get_mark/${markId}`);
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showMarkInfo(result.mark);
                    currentMarkId = markId;
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—Ç–µ');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
            }
        }

        function showMarkInfo(mark) {
            document.getElementById('viewMarkTitle').textContent = mark.title || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            document.getElementById('viewMarkDate').textContent = mark.visit_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            document.getElementById('viewMarkAddress').textContent = mark.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
            document.getElementById('viewMarkDescription').textContent = mark.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
            
            const mainPhotoSection = document.getElementById('mainPhotoSection');
            const mainPhoto = document.getElementById('viewMainPhoto');
            
            if (mark.main_photo) {
                mainPhoto.src = mark.main_photo;
                mainPhoto.style.display = 'block';
                mainPhoto.onclick = () => openPhotoModal(mark.main_photo);
                mainPhotoSection.style.display = 'block';
            } else {
                mainPhotoSection.style.display = 'none';
            }
            
            const secondarySection = document.getElementById('secondaryPhotosSection');
            const photosGrid = document.getElementById('secondaryPhotosGrid');
            photosGrid.innerHTML = '';
            
            if (mark.photos && mark.photos.length > 0) {
                // print("count of photos: ", mark.photos.length)
                mark.photos.forEach((photo, index) => {
                    const img = document.createElement('img');
                    img.src = photo;
                    img.className = 'photo-thumb';
                    img.alt = `–§–æ—Ç–æ –º–µ—Å—Ç–∞ ${index + 1}`;
                    img.onclick = () => openPhotoModal(photo);
                    photosGrid.appendChild(img);
                });
                secondarySection.style.display = 'block';
            } else {
                secondarySection.style.display = 'none';
            }
            
            document.getElementById('viewMarkPanel').classList.remove('hidden');
        }

        function closeViewMarkPanel() {
            document.getElementById('viewMarkPanel').classList.add('hidden');
            currentMarkId = null;
        }

        function openPhotoModal(photoData) {
            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.innerHTML = `
                <div class="photo-modal-content">
                    <span class="photo-modal-close" onclick="this.parentElement.parentElement.remove()">√ó</span>
                    <img src="${photoData}" alt="–§–æ—Ç–æ –º–µ—Å—Ç–∞">
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeViewMarkPanel();
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function deleteMark() {
            if (!currentMarkId || !confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—Ç–∫—É?')) return;
            
            fetch(`/api/delete_mark/${TELEGRAM_USER_ID}/${currentMarkId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showNotification('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                        closeViewMarkPanel();
                        location.reload();
                    }
                })
                .catch(error => {
                    showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                });
        }

        function editMark() {
            if (!currentMarkId) return;
            
            fetch(`/api/get_mark/${currentMarkId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showEditForm(result.mark);
                    }
                })
                .catch(error => {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                });
        }

        function showEditForm(mark) {
            currentEditingMark = mark;
            
            document.getElementById('editPlaceTitle').value = mark.title || '';
            document.getElementById('editPlaceDescription').value = mark.description || '';
            document.getElementById('editPlaceDate').value = mark.visit_date || '';
            document.getElementById('editPlaceAddress').value = mark.address || '';
            
            loadEditPhotos(mark);
            
            document.getElementById('viewMarkPanel').classList.add('hidden');
            document.getElementById('editMarkPanel').classList.remove('hidden');
        }

        function loadEditPhotos(mark) {
            editUploadedPhotos = { main: null, secondary: [] };
            
            const mainPreview = document.getElementById('editMainPhotoPreview');
            if (mark.main_photo) {
                mainPreview.innerHTML = `<img src="${mark.main_photo}" alt="–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ">`;
                mainPreview.classList.add('has-photo');
            } else {
                mainPreview.innerHTML = '<span class="photo-placeholder">üì∑</span><div class="photo-label">–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ</div>';
                mainPreview.classList.remove('has-photo');
            }
            
            const secondaryPreview = document.getElementById('editSecondaryPhotoPreview');
            if (mark.photos && mark.photos.length > 0) {
                let previewHTML = mark.photos.length === 1 ? 
                    `<img src="${mark.photos[0]}" alt="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ">` :
                    '<div class="photo-preview-grid">' + 
                    mark.photos.slice(0, 4).map(photo => `<img src="${photo}" alt="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ">`).join('') +
                    '</div>';
                previewHTML += `<div class="photo-counter">${mark.photos.length}/${MAX_SECONDARY_PHOTOS}</div>`;
                secondaryPreview.innerHTML = previewHTML;
                secondaryPreview.classList.add('has-photos');
                
                mark.photos.forEach(photoUrl => {
                    editUploadedPhotos.secondary.push({ url: photoUrl, file: null });
                });
            } else {
                secondaryPreview.innerHTML = '<span class="photo-placeholder">‚ûï</span><div class="photo-label secondary">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ</div>';
                secondaryPreview.classList.remove('has-photos');
            }
        }

        function handleEditMainPhotoUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('editMainPhotoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ">`;
                    preview.classList.add('has-photo');
                    editUploadedPhotos.main = file;
                };
                reader.readAsDataURL(file);
            }
        }

        function handleEditSecondaryPhotoUpload(event) {
            const files = Array.from(event.target.files);
            const availableSlots = MAX_SECONDARY_PHOTOS - editUploadedPhotos.secondary.length;
            
            if (availableSlots <= 0) {
                showNotification(`–ú–∞–∫—Å–∏–º—É–º –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å ${MAX_SECONDARY_PHOTOS} –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ`, 'warning');
                return;
            }
            
            const filesToUpload = files.slice(0, availableSlots);
            
            filesToUpload.forEach((file) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        editUploadedPhotos.secondary.push({
                            file: file,
                            url: e.target.result
                        });
                        updateEditSecondaryPhotoPreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function updateEditSecondaryPhotoPreview() {
            const preview = document.getElementById('editSecondaryPhotoPreview');
            const photoCount = editUploadedPhotos.secondary.length;
            
            if (photoCount === 0) {
                preview.innerHTML = '<span class="photo-placeholder">‚ûï</span><div class="photo-label secondary">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ</div>';
                preview.classList.remove('has-photos');
                return;
            }
            
            let previewHTML = '';
            
            if (photoCount === 1) {
                previewHTML = `<img src="${editUploadedPhotos.secondary[0].url}" alt="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ 1">`;
            } else {
                previewHTML = '<div class="photo-preview-grid">';
                editUploadedPhotos.secondary.slice(0, 4).forEach((photo, index) => {
                    previewHTML += `<img src="${photo.url}" alt="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ ${index + 1}">`;
                });
                previewHTML += '</div>';
            }
            
            previewHTML += `<div class="photo-counter">${photoCount}/${MAX_SECONDARY_PHOTOS}</div>`;
            preview.innerHTML = previewHTML;
            preview.classList.add('has-photos');
        }

        function removeEditMainPhoto() {
            const preview = document.getElementById('editMainPhotoPreview');
            preview.innerHTML = '<span class="photo-placeholder">üì∑</span><div class="photo-label">–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ</div>';
            preview.classList.remove('has-photo');
            editUploadedPhotos.main = null;
            document.getElementById('editMainPhotoInput').value = '';
        }

        function removeAllEditSecondaryPhotos() {
            const preview = document.getElementById('editSecondaryPhotoPreview');
            preview.innerHTML = '<span class="photo-placeholder">‚ûï</span><div class="photo-label secondary">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ</div>';
            preview.classList.remove('has-photos');
            editUploadedPhotos.secondary = [];
            document.getElementById('editSecondaryPhotoInput').value = '';
        }

        function cancelEdit() {
            document.getElementById('editMarkPanel').classList.add('hidden');
            document.getElementById('viewMarkPanel').classList.remove('hidden');
            editUploadedPhotos = { main: null, secondary: [] };
        }

        function handleEditAddressKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                hideEditSuggestions();
                geocodeEditAddress();
            }
        }

        function showEditSuggestions(query) {
            if (!query || query.length < 2) {
                hideEditSuggestions();
                return;
            }
            
            clearTimeout(suggestTimeout);
            suggestTimeout = setTimeout(() => {
                ymaps.suggest(query, {
                    boundedBy: map.getBounds(),
                    strictBounds: false,
                    results: 5
                }).then(function(items) {
                    const container = document.getElementById('editSuggestions');
                    container.innerHTML = '';
                    
                    if (items.length === 0) {
                        hideEditSuggestions();
                        return;
                    }
                    
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        const icon = getSuggestionIcon(item);
                        div.innerHTML = `
                            <span class="suggestion-icon">${icon}</span>
                            <span class="suggestion-text">${item.value}</span>
                        `;
                        
                        div.onclick = function() {
                            document.getElementById('editPlaceAddress').value = item.value;
                            hideEditSuggestions();
                            geocodeEditAddress();
                        };
                        container.appendChild(div);
                    });
                    
                    container.classList.remove('hidden');
                });
            }, 200);
        }

        function hideEditSuggestions() {
            document.getElementById('editSuggestions').classList.add('hidden');
        }

        function geocodeEditAddress() {
            const query = document.getElementById('editPlaceAddress').value.trim();
            
            if (!query) {
                updateEditAddressStatus('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞', 'warning');
                return;
            }
            
            updateEditAddressStatus('–ò—â–µ–º...', 'loading');
            hideEditSuggestions();
            
            ymaps.geocode(query, {
                results: 1,
                boundedBy: map.getBounds(),
                strictBounds: false
            }).then(function(res) {
                const foundObjects = res.geoObjects;
                
                if (foundObjects.getLength() === 0) {
                    return ymaps.geocode(query, { results: 1 });
                }
                return res;
                
            }).then(function(res) {
                const foundObjects = res.geoObjects;
                
                if (foundObjects.getLength() === 0) {
                    updateEditAddressStatus('–ú–µ—Å—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å', 'error');
                    return;
                }
                
                const firstFoundObject = foundObjects.get(0);
                const foundAddress = firstFoundObject.getAddressLine();
                
                let foundName = firstFoundObject.properties.get('name');
                if (!foundName || foundName === foundAddress) {
                    foundName = query;
                }
                
                if (!document.getElementById('editPlaceTitle').value) {
                    document.getElementById('editPlaceTitle').value = foundName;
                }
                
                document.getElementById('editPlaceAddress').value = foundAddress;
                updateEditAddressStatus('–ú–µ—Å—Ç–æ –Ω–∞–π–¥–µ–Ω–æ!', 'success');
                
            }).catch(function(err) {
                console.log('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', err);
                updateEditAddressStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—Ä–æ—Å', 'error');
            });
        }

        function updateEditAddressStatus(message, type) {
            const statusElement = document.getElementById('editAddressStatus');
            statusElement.textContent = message;
            statusElement.className = 'address-status ' + type;
        }

        async function saveEditedMark() {
            const title = document.getElementById('editPlaceTitle').value.trim();
            if (!title) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞', 'error');
                return;
            }
            
            const saveButton = document.getElementById('saveEditButton');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            saveButton.disabled = true;
            
            try {
                const address = document.getElementById('editPlaceAddress').value.trim();
                
                const formData = new FormData();
                formData.append('title', title);
                formData.append('description', document.getElementById('editPlaceDescription').value);
                formData.append('visit_date', document.getElementById('editPlaceDate').value);
                formData.append('address', address);
                
                if (editUploadedPhotos.main) {
                    formData.append('main_photo', editUploadedPhotos.main);
                }
                
                editUploadedPhotos.secondary.forEach((photo, index) => {
                    if (photo.file) {
                        formData.append(`secondary_photos`, photo.file);
                    }
                });
                
                const response = await fetch(`/api/update_mark/${TELEGRAM_USER_ID}/${currentMarkId}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                const result = await response.json();
                showNotification('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
                cancelEdit();
                closeViewMarkPanel();
                location.reload();
                
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }
        
        {% if is_admin %}
        function setupAdminFeatures() {
            map.events.add('click', function(e) {
                if (addPlaceListener) {
                    showTempMarker(e.get('coords'));
                }
            });
        }

        function showTempMarker(coords) {
            selectedCoords = coords;
        
            if (tempMarker) {
                map.geoObjects.remove(tempMarker);
            }
        
            tempMarker = new ymaps.Placemark(coords, {}, {
                preset: 'islands#redIcon',
                draggable: true,
                balloonContent: '–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ'
            });
        
            map.geoObjects.add(tempMarker);
            getAddressFromCoords(coords);
        
            tempMarker.events.add('dragend', function() {
                const newCoords = tempMarker.geometry.getCoordinates();
                selectedCoords = newCoords;
                getAddressFromCoords(newCoords);
            });
            
            document.getElementById('addPlacePanel').classList.remove('hidden');
        }
        
        function geocodeAddress() {
            const query = document.getElementById('placeAddress').value.trim();
            
            if (!query) {
                updateAddressStatus('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞', 'warning');
                return;
            }
            
            updateAddressStatus('–ò—â–µ–º...', 'loading');
            hideSuggestions();
            
            ymaps.geocode(query, {
                results: 1,
                boundedBy: map.getBounds(),
                strictBounds: false
            }).then(function(res) {
                const foundObjects = res.geoObjects;
                
                if (foundObjects.getLength() === 0) {
                    return ymaps.geocode(query, { results: 1 });
                }
                return res;
                
            }).then(function(res) {
                const foundObjects = res.geoObjects;
                
                if (foundObjects.getLength() === 0) {
                    updateAddressStatus('–ú–µ—Å—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å', 'error');
                    return;
                }
                
                const firstFoundObject = foundObjects.get(0);
                const foundCoords = firstFoundObject.geometry.getCoordinates();
                const foundAddress = firstFoundObject.getAddressLine();
                
                let foundName = firstFoundObject.properties.get('name');
                if (!foundName || foundName === foundAddress) {
                    foundName = query;
                }
                
                selectedCoords = foundCoords;
                selectedAddress = foundAddress;
                
                if (!document.getElementById('placeTitle').value) {
                    document.getElementById('placeTitle').value = foundName;
                }
                
                document.getElementById('placeAddress').value = foundAddress;
                
                if (tempMarker) {
                    tempMarker.geometry.setCoordinates(foundCoords);
                } else {
                    showTempMarker(foundCoords);
                }
                
                map.setCenter(foundCoords, 16, {duration: 500});
                updateAddressStatus('–ú–µ—Å—Ç–æ –Ω–∞–π–¥–µ–Ω–æ!', 'success');
                
            }).catch(function(err) {
                console.log('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', err);
                updateAddressStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—Ä–æ—Å', 'error');
            });
        }
        
        function showSuggestions(query) {
            if (!query || query.length < 2) {
                hideSuggestions();
                return;
            }
            
            clearTimeout(suggestTimeout);
            suggestTimeout = setTimeout(() => {
                ymaps.suggest(query, {
                    boundedBy: map.getBounds(),
                    strictBounds: false,
                    results: 5
                }).then(function(items) {
                    const container = document.getElementById('suggestions');
                    container.innerHTML = '';
                    
                    if (items.length === 0) {
                        hideSuggestions();
                        return;
                    }
                    
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        const icon = getSuggestionIcon(item);
                        div.innerHTML = `
                            <span class="suggestion-icon">${icon}</span>
                            <span class="suggestion-text">${item.value}</span>
                        `;
                        
                        div.onclick = function() {
                            document.getElementById('placeAddress').value = item.value;
                            hideSuggestions();
                            geocodeAddress();
                        };
                        container.appendChild(div);
                    });
                    
                    container.classList.remove('hidden');
                });
            }, 200);
        }
        
        function getSuggestionIcon(item) {
            const types = item.tags || [];
            if (types.includes('street')) return 'üè†';
            if (types.includes('metro')) return 'üöá';
            if (types.includes('house')) return 'üìç';
            if (types.includes('organization')) return 'üè¢';
            if (types.includes('attraction')) return 'üèõÔ∏è';
            return 'üîç';
        }
        
        function hideSuggestions() {
            document.getElementById('suggestions').classList.add('hidden');
        }
        
        function getAddressFromCoords(coords) {
            updateAddressStatus('–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å...', 'loading');
            
            ymaps.geocode(coords).then(function(res) {
                const firstGeoObject = res.geoObjects.get(0);
                
                if (firstGeoObject) {
                    const address = firstGeoObject.getAddressLine();
                    selectedAddress = address;
                    document.getElementById('placeAddress').value = address;
                    updateAddressStatus('–ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω', 'success');
                } else {
                    selectedAddress = '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                    document.getElementById('placeAddress').value = '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                    updateAddressStatus('–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω', 'warning');
                }
            }).catch(function(err) {
                console.log('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                selectedAddress = '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                document.getElementById('placeAddress').value = '–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                updateAddressStatus('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞', 'error');
            });
        }
        
        function handleAddressKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                hideSuggestions();
                geocodeAddress();
            }
        }
        
        function updateAddressStatus(message, type) {
            const statusElement = document.getElementById('addressStatus');
            statusElement.textContent = message;
            statusElement.className = 'address-status ' + type;
        }
        
        function toggleAddMode() {
            if (addPlaceListener) {
                disableAddMode();
            } else {
                enableAddMode();
            }
        }
        
        function enableAddMode() {
            document.querySelector('.controls .btn-primary').classList.add('active');
            addPlaceListener = true;
            updateAddressStatus('–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å/–Ω–∞–∑–≤–∞–Ω–∏–µ', 'info');
        }
        
        function disableAddMode() {
            document.querySelector('.controls .btn-primary').classList.remove('active');
            document.getElementById('addPlacePanel').classList.add('hidden');
            hideSuggestions();
            
            if (tempMarker) {
                map.geoObjects.remove(tempMarker);
                tempMarker = null;
            }
            
            resetPhotoUploads();
            
            document.getElementById('placeTitle').value = '';
            document.getElementById('placeDescription').value = '';
            document.getElementById('placeAddress').value = '';
            updateAddressStatus('', '');
            
            addPlaceListener = null;
            selectedCoords = null;
            selectedAddress = '';
        }
        
        function resetPhotoUploads() {
            removeMainPhoto();
            removeAllSecondaryPhotos();
        }
        
        async function savePlace() {
            const title = document.getElementById('placeTitle').value.trim();
            if (!title || !selectedCoords) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ', 'error');
                return;
            }
            
            const saveButton = document.getElementById('saveButton');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            saveButton.disabled = true;
            
            try {
                const address = document.getElementById('placeAddress').value.trim() || selectedAddress;
                
                const formData = new FormData();
                formData.append('user_telegram_id', TELEGRAM_USER_ID);
                formData.append('title', title);
                formData.append('description', document.getElementById('placeDescription').value);
                formData.append('visit_date', document.getElementById('placeDate').value);
                formData.append('lat', selectedCoords[0]);
                formData.append('lon', selectedCoords[1]);
                formData.append('address', address);
                
                if (uploadedPhotos.main) {
                    formData.append('main_photo', uploadedPhotos.main);
                }
                
                uploadedPhotos.secondary.forEach((photo, index) => {
                    formData.append(`secondary_photos`, photo.file);
                });
                
                const response = await fetch(`api/create_mark`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                const result = await response.json();
                showNotification('–ú–µ—Å—Ç–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');
                
                createPlacemark(result.mark);
                
                disableAddMode();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }
        
        function cancelAddPlace() {
            disableAddMode();
        }
        
        function shareMap() {
            const shareUrl = `${window.location.origin}/guest/${TELEGRAM_USER_ID}`;
            if (navigator.share) {
                navigator.share({
                    title: '–ú–æ—è –∫–∞—Ä—Ç–∞ "–ë—ã–ª–æ –¥–µ–ª–æ"',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!\n\n' + shareUrl);
                });
            }
        }

        // function shareMap() {
        //     const shareUrl = `${window.location.origin}/guest/${TELEGRAM_USER_ID}`;
            
        //     // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–æ–≤ Telegram Web App
        //     if (window.Telegram && window.Telegram.WebApp) {
        //         const tg = window.Telegram.WebApp;
                
        //         // –ú–µ—Ç–æ–¥ shareUrl –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö
        //         if (tg.shareUrl && tg.isVersionAtLeast('6.0')) {
        //             tg.shareUrl(shareUrl, '–ú–æ—è –∫–∞—Ä—Ç–∞ "–ë—ã–ª–æ –¥–µ–ª–æ"');
        //         } 
        //         // –ú–µ—Ç–æ–¥ showAlert –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –≤–µ—Ä—Å–∏–π
        //         else if (tg.showAlert) {
        //             tg.showAlert(`–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∞—à–µ–π –∫–∞—Ä—Ç—ã:\n\n${shareUrl}`, '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–∞—Ä—Ç–æ–π');
        //         }
        //         // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
        //         else {
        //             copyToClipboard(shareUrl);
        //         }
        //     } else {
        //         // –ï—Å–ª–∏ –Ω–µ –≤ Telegram Web App, –∏—Å–ø–æ–ª—å–∑—É–µ–º Web Share API –∏–ª–∏ fallback
        //         if (navigator.share) {
        //             navigator.share({
        //                 title: '–ú–æ—è –∫–∞—Ä—Ç–∞ "–ë—ã–ª–æ –¥–µ–ª–æ"',
        //                 url: shareUrl
        //             }).catch(() => copyToClipboard(shareUrl));
        //         } else {
        //             copyToClipboard(shareUrl);
        //         }
        //     }
        // }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function() {
                    showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                }).catch(function() {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        // Fallback –º–µ—Ç–æ–¥ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            } catch (err) {
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', 'error');
                console.error('Fallback: Oops, unable to copy', err);
            }
            
            document.body.removeChild(textArea);
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'info') {
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ alert
            const notification = document.createElement('div');
            notification.className = `custom-notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            
            // –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#34C759' : type === 'error' ? '#FF3B30' : '#007AFF'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 90%;
                animation: slideDown 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // –î–æ–±–∞–≤—å –∞–Ω–∏–º–∞—Ü–∏—é –≤ CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    transform: translateX(-50%) translateY(-100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
            }
            
            .notification-content {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
            }
            
            .notification-close {
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                padding: 0;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        `;
        document.head.appendChild(style);
        {% endif %}
    </script>
</body>
</html>